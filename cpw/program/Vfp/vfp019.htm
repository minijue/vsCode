<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title>您现在的位置是</title>
</head>

<body>

<div align="center"><center>

<table border="1" cellspacing="0" cellpadding="2" width="100%" style="font-size: 9pt"
bordercolor="#000000" bordercolordark="#FFFFFF">
  <tr bgcolor="#CCFFCC">
    <td><span style="font-size: 9pt">您现在的位置是： <b><a href="../progidx.htm">编程技巧</a> --&gt; 
      <a href="Vfp_idx.htm">VFP</a></b></span></td>      
  </tr>      
</table>      
</center></div><div align="center"><center>      
      
<table border="1" width="100%" style="font-size: 9pt" bgcolor="#FFFFFF"      
bordercolor="#000000" cellpadding="2" cellspacing="0" bordercolordark="#FFFFFF">      
  <tr>      
    <td width="85%" align="left" valign="top"><table border="1" width="32%" style="font-size: 9pt" height="30"      
    cellspacing="0" cellpadding="2" bgcolor="#FFFFFF" bordercolor="#000000"      
    bordercolordark="#FFFFFF">      
      <tr>      
        <td width="100%" bgcolor="#4264B5"><p align="center"><span style="font-size: 9pt"><font      
        color="#FFFFFF">资料整理&middot;<a href="http://chinaprog.yeah.net" target="_blank"      
        style="color: rgb(255,255,255)">中国程序员网站</a></font></span></td>      
      </tr>      
    </table>      
      <p align="center">FOXPRO低级文件函数读写数据及应用&nbsp;<br>
      <br>
                             (江西 熊正华)&nbsp;      
      <p><br>
      　　Foxpro是在Foxbase基础上发展起来的一个强大的关系型数据库系统，从Foxpro2.0起系统性能更加突出，功能也有较大的扩展，并提供了一系列用于文件读写的低级文件操作函数。&nbsp;<br>
      　　然而Foxpro低级文件函数处理的数据对象仅局限于字符数据，对数值数据则无直接的读写能力。要弥补这一不足，一种可选择的方法是采用C语言编写新的文件读写函数，但这对一般的Foxpro用户并不容易。笔者经过一番摸索，发现只要经过适当的数据转换，完全可利用Foxpro本身所提供的语言系统解决某些应用问题。&nbsp;<br>
      　　一般来说，数值数据在文件中有三种存放格式：一是十进数ASCⅡ码格式，文件中存放的是十进制数码符(0－9)、小数点和正负号所对应的ASCⅡ码；二是二进制整数格式，负整数用补码表示，各字节值与256进制数的各数码值(从低位到高位)相同；三是二进制浮点数格式，数据用规格化的指数形式表示，分单精度数和双精度数。&nbsp;<br>
      　　据分析，文件中的数据是按字节存放的，且每个字节的值都可理解成一个ASCⅡ(包括扩展码)，因此存放于文件中任何格式的数值数据均能转换为Foxpro低级文件函数读写的ASCⅡ码字符串。对于十进制ASCⅡ码格式和二进制整数格式的数值数据，具体的转换方法是：&nbsp;<br>
      　　1、按ASCⅡ码格式写数值数据时，可用类型转换函数str()将数值数据转换为ASCⅡ码格式的字符串。从文件中读ASCⅡ码格式的数值数据时，应将读出的字符串用函数VAL()或宏＆代换还原成数值数据。&nbsp;<br>
      　　2、按二进制整数格式写无符号整数时，应根据数制转换规则求出256进制数的各位数码值，并用函数chr()转换为字符后反位序(从低位到高位)合并成串。从文件中读二进制格式的无符号整数时，需用256进数转换为10进数的方法转换所读取的字符数据。&nbsp;<br>
      　　3、按二进制格式写有符号整数时，需将其转换为补码后再用方法2进行转换。从文件中读二进制格式的有符号整数时，对返回的数值数据要作补码还原运算。数据A的补码可用下式表示：&nbsp;<br>
      　　【A】补=2n－A原&nbsp;<br>
      　　其中：N=1，表1字节整数&nbsp;<br>
      　　2，表2字节短整&nbsp;<br>
      　　4，表4字节长整&nbsp;<br>
      　　8，表8字节整数&nbsp;<br>
      　　对于浮点格式的数据转换，由于要涉及到二进制位运算，且仅foxpro的自身语言系统难以实现，限于篇幅本文也不作具体讨论，有兴趣的读者可参考有关书籍。&nbsp;<br>
      　　经上述方法转换后的数值型数据，都可以很方便地使用foxpro低级文件函数进行读写。在Novell局域网环境下，操作人员不正确退网关机常造成数据库文件损坏。下面是一个foxpro低级文件函数读写数值数据的应用程序实例，用于修复已损坏的数据库。程序已在AST/P133微机上运行通过。&nbsp;<br>
      　　附程序清单：&nbsp;<br>
      　　＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊&nbsp;<br>
      　　＊程序名：dbf－fix.prg&nbsp;<br>
      　　set talk off&nbsp;<br>
      　　set colo to&nbsp;<br>
      　　clear&nbsp;<br>
      　　Dname＋space(40)&nbsp;<br>
      　　@1,1 say `数据库文件名：`get Dname&nbsp;<br>
      　　read&nbsp;<br>
      　　Dname=allt(Dname)&nbsp;<br>
      　　Fh=fopen(Dname,2)&nbsp;<br>
      　　if Fh=－1&nbsp;<br>
      　　wait wind `数据库文件`＋Dname＋`不存在!`&nbsp;<br>
      　　=fclose(Fh)&nbsp;<br>
      　　return&nbsp;<br>
      　　endif&nbsp;<br>
      　　Flen=fseek(Fh,0,2) ＆＆读文件长&nbsp;<br>
      　　if Flen&lt;32&nbsp;<br>
      　　wait wind Danme＋`不是一个数据库!`&nbsp;<br>
      　　=fclose(Fh)&nbsp;<br>
      　　retu&nbsp;<br>
      　　endif&nbsp;<br>
      　　=fseek(Fh,0,0)&nbsp;<br>
      　　C1=fread(Fh,1)&nbsp;<br>
      　　if .not. (asc(C1)=3.or.asc(C1)=245)&nbsp;<br>
      　　wait wind Danme＋`不是一个数据库!`&nbsp;<br>
      　　=fclose(Fh)&nbsp;<br>
      　　retu&nbsp;<br>
      　　endi&nbsp;<br>
      　　=fseek(Fh,4,0)&nbsp;<br>
      　　Rnum=CTON(fread(Fh,4)) ＆＆库头登记的记录数&nbsp;<br>
      　　Hlen=CTON(fread(Fh,2)) ＆＆库头长&nbsp;<br>
      　　Rlen=CTON(fread(Fh,2)) ＆＆库头登记的记录长&nbsp;<br>
      　　if Flen　　wait wind Dname＋`不是一个数据库!`&nbsp;<br>
      　　=fclose(Fh)&nbsp;<br>
      　　retu&nbsp;<br>
      　　endif&nbsp;<br>
      　　if Flen　　byte=Flen－Hlen&nbsp;<br>
      　　recnum=int(byte/Rlen) ＆＆可修复的记录数&nbsp;<br>
      　　C4=NTOC(recnum,4) ＆＆转换为256进制格式串&nbsp;<br>
      　　YN=`Y`&nbsp;<br>
      　　clear&nbsp;<br>
      　　@1,1 say `错误：数据库已部分损坏!`&nbsp;<br>
      　　@3,1 say `可修复记录数为`＋transform(recnum,`99999999`)＋;&nbsp;<br>
      　　`,接受该值?(Y/N:)`get YN&nbsp;<br>
      　　read&nbsp;<br>
      　　if upper(YN)=`Y`&nbsp;<br>
      　　=fseek(Fh,4,0)&nbsp;<br>
      　　=fwrite(Fh,C4) ＆＆向库头写修复的记录数&nbsp;<br>
      　　endi&nbsp;<br>
      　　else&nbsp;<br>
      　　WAIT WIND `数据库＆Dname,完好无损，不需修复...`&nbsp;<br>
      　　endi&nbsp;<br>
      　　=fclose(Fh)&nbsp;<br>
      　　return&nbsp;<br>
      　　＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊&nbsp;<br>
      　　＊函数：NtoC(,)&nbsp;<br>
      　　＊参数：expN1=无符号整数&nbsp;<br>
      　　＊expN2=整数类型 1 一字节整数&nbsp;<br>
      　　＊ 2 二字节短整&nbsp;<br>
      　　＊ 4 四字节长整&nbsp;<br>
      　　＊返回：256进制格式(二进数的字符表示)串&nbsp;<br>
      　　＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊&nbsp;<br>
      　　FUNC NtoC&nbsp;<br>
      　　para unsigned,N&nbsp;<br>
      　　priv M,J,C256&nbsp;<br>
      　　M=unsigned&nbsp;<br>
      　　C256=``&nbsp;<br>
      　　do while n>0&nbsp;<br>
      　　J=mod(M,256) ＆＆先求低位数码值&nbsp;<br>
      　　M=int(M/256)&nbsp;<br>
      　　C256=C256＋chr(J)&nbsp;<br>
      　　N=N－1&nbsp;<br>
      　　enddo&nbsp;<br>
      　　return C256&nbsp;<br>
      　　＊＊＊＊＊＊＊＊＊＊＊＊&nbsp;<br>
      　　＊函数：CtoN()&nbsp;<br>
      　　＊参数：expC=256进制格式的字符串&nbsp;<br>
      　　＊返回：无符号整数&nbsp;<br>
      　　＊＊＊＊＊＊＊＊＊＊＊＊&nbsp;<br>
      　　FUNC CtoN&nbsp;<br>
      　　para C256&nbsp;<br>
      　　priv M,R,L&nbsp;<br>
      　　M=C256&nbsp;<br>
      　　L=0&nbsp;<br>
      　　do while len(M)>0&nbsp;<br>
      　　R=asc(right(M,1))&nbsp;<br>
      　　if len(M)>1&nbsp;<br>
      　　M=left(M,len(M)－1)&nbsp;<br>
      　　else&nbsp;<br>
      　　M=``&nbsp;<br>
      　　endif&nbsp;<br>
      　　L=L＋R＊256＊＊len(M)&nbsp;<br>
      　　enddo&nbsp;<br>
      　　return L      
    </td>     
  </tr>     
</table>     
</center></div>     
<p>　</p>

</body>

</html>
