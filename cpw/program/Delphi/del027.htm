<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title>您现在的位置是</title>
</head>

<body>

<div align="center"><center>

<table border="1" cellspacing="0" cellpadding="2" width="100%" style="font-size: 9pt"
bordercolor="#000000" bordercolordark="#FFFFFF">
  <tr bgcolor="#CCFFCC">
    <td><span style="font-size: 9pt">您现在的位置是： <b><a href="../progidx.htm">编程技巧</a> --&gt; 
      <a href="Del_idx.htm">DELPHI</a></b></span></td>    
  </tr>    
</table>    
</center></div><div align="center"><center>    
    
<table border="1" width="100%" style="font-size: 9pt" bgcolor="#FFFFFF"    
bordercolor="#000000" cellpadding="2" cellspacing="0" bordercolordark="#FFFFFF">    
  <tr>    
    <td width="85%" align="left" valign="top"><table border="1" width="32%" style="font-size: 9pt" height="30"    
    cellspacing="0" cellpadding="2" bgcolor="#FFFFFF" bordercolor="#000000"    
    bordercolordark="#FFFFFF">    
      <tr>    
        <td width="100%" bgcolor="#4264B5"><p align="center"><span style="font-size: 9pt"><font    
        color="#FFFFFF">资料整理&middot;<a href="http://chinaprog.yeah.net" target="_blank"    
        style="color: rgb(255,255,255)">中国程序员网站</a></font></span></td>    
      </tr>    
    </table>    
      <p align="center">利用Delphi编程发送E－mail&nbsp;<br>
      <br>
                             (上海　钱可栋)    
      <p><br>
      <br>
      　　接发E－mail是许多“网虫”必修的功课，E－mail工具软件也很多，国外的有Microsoft的Outlook Express、The Bat等，国内则有FoxMail这样的精品。其实，利用可视化编程工具Delphi4.0也能够制作出自己的E－mail软件。<br> 
      　　Delphi4.0有关E－mail的组件有两个：NmPOP3和NmSTMP，它们都位于Internet选项卡上，其中，NmPOP3组件封装并实现POP3协议，用来从Internet POP3服务器上读取电子邮件；NmSTMP封装并实现STMP协议，可用来向Internet的STMP服务器发送电子邮件。限于篇幅，我们不能两者都介绍，这里只用NmSTMP编写一个发送E－mail的程序，至于NmPOP3，以后有机会再谈，或者在看完本文后你有兴趣，也可以借助于Delphi的帮助文档尝试用NmPOP3编程。<br> 
      　　我们先来看一下程序运行界面。图1是程序主窗体，上面有一个字符串网格（StringGrid）和三个按钮，它们的容器是仅有一个标签的PageControl。单击“Clear”钮清除网格内容，单击“Send”钮发送E－mail，单击“New Mail”钮弹出图2所示的对话框，此对话框用来设置STMP服务器名称、发件人地址、收件人地址、发件人名称和邮件主题，其中前三项必须填写，“Select File”按钮用来打开Open对话框，以便选取要发送的附件。<br> 
      　　NmSTMP的属性和方法不多，关键的属性是Host（STMP服务器名称）和PostMessage（包含邮件信息），正确设置了Host属性和PostMessage属性后，就可以用Connect方法（连接服务器）和SendMail方法发送E－mail了。<br>
      　　编写代码之前先要改变StringGrid1的一些缺省属性：ColCount属性为6，FixedCols属性为0，RowCount属性为2，另外，将PageControl1的Align属性置为alClient。<br>
      　　以下是Unit1（主窗体）代码清单：<br>
      　　unit Unit1;<br> 
      　　interface<br>
      　　uses<br>
      　　 Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms,&nbsp;<br>
     Dialogs, Grids, ComCtrls, StdCtrls, Psock, NMsmtp;<br> 
      　　type<br>
      　　 TForm1 = class(TForm)<br> 
      　　 PageControl1: TPageControl;<br> 
      　　 TabSheet1: TTabSheet;<br> 
      　　 StatusBar1: TStatusBar;<br> 
      　　 StringGrid1: TStringGrid;<br> 
      　　 Button1: TButton;<br> 
      　　 Button2: TButton;<br> 
      　　 Button3: TButton;<br> 
      　　 NMSMTP1: TNMSMTP;<br> 
      　　 procedure FormCreate(Sender: TObject);<br> 
      　　 procedure Button1Click(Sender: TObject);<br> 
      　　 procedure Button2Click(Sender: TObject);<br> 
      　　 procedure Button3Click(Sender: TObject);<br> 
      　　 procedure NMSMTP1Failure(Sender: TObject);<br> 
      　　 procedure NMSMTP1SendStart(Sender: TObject);<br> 
      　　 procedure NMSMTP1Success(Sender: TObject);<br> 
      　　 private<br> 
      　　 { Private declarations }<br> 
      　　 public<br> 
      　　 { Public declarations }<br> 
      　　 end;<br> 
      　　var<br>
      　　 Form1: TForm1;<br> 
      　　implementation<br>
      　　uses Unit2;<br> 
      　　{＄R ＊.DFM}<br> 
      　　procedure TForm1.FormCreate(Sender: TObject);<br> 
      　　begin<br>
      　　 PageControl1.Pages[0].Caption:=‘Send Mail’;<br> 
      　　 self.Caption:=‘My Mailer’;<br> 
      　　 self.BorderIcons:=[biSystemMenu,biMinimize];<br> 
      　　 self.BorderStyle:=bsSingle;<br> 
      　　 Application.Icon:=self.Icon;&nbsp;<br>
      　　 Application.Title:=self.Caption;&nbsp;<br>
      　　 with StringGrid1 do<br> 
      　　 begin<br> 
      　　 Cells[0,0]:=‘Host’;<br> 
      　　 Cells[1,0]:=‘To Address’;<br> 
      　　 Cells[2,0]:=‘From Address’;<br> 
      　　 Cells[3,0]:=‘Your Name’;<br> 
      　　 Cells[4,0]:=‘Subject’;<br> 
      　　 Cells[5,0]:=‘File’;<br> 
      　　 end;<br> 
      　　 Button2.Enabled:=False;<br> 
      　　 Button3.Enabled:=False;<br> 
      　　end;<br>
      　　procedure TForm1.Button1Click(Sender: TObject);<br> 
      　　begin<br>
      　　 Form2.Show;<br> 
      　　end;<br>
      　　procedure TForm1.Button2Click(Sender: TObject);<br> 
      　　var<br>
      　　i:Integer;<br>
      　　begin<br>
      　　 for i:=1 to StringGrid1.RowCount－2 do<br> 
      　　 with Nmsmtp1 do<br> 
      　　 begin<br> 
      　　 Host:=StringGrid1.Cells[0,i];<br> 
      　　PostMessage.ToAddress.Add(StringGrid1.Cells[1,i]);<br>
      　　PostMessage.FromAddress:=StringGrid1.Cells[2,i];<br>
      　　PostMessage.FromName:=StringGrid1.Cells[3,i];<br>
      　　PostMessage.Subject:=StringGrid1.Cells[4,i];<br>
      　　 PostMessage.Attachments.Add(StringGrid1.Cells[5,i]);<br> 
      　　 Connect;<br> 
      　　 Sendmail;<br> 
      　　 DisConnect;<br> 
      　　 end;<br> 
      　　 Button2.Enabled:=False;<br> 
      　　 Button3.Click;<br> 
      　　 end;<br> 
      　　procedure TForm1.Button3Click(Sender: TObject);<br> 
      　　var<br>
      　　i:Integer;<br>
      　　begin<br>
      　　 with StringGrid1 do<br> 
      　　 begin<br> 
      　　 for i:=1 to RowCount－2 do<br> 
      　　 begin<br> 
      　　 Cells[0,i]:=‘’;<br> 
      　　 Cells[1,i]:=‘’;<br> 
      　　 Cells[2,i]:=‘’;<br> 
      　　 Cells[3,i]:=‘’;<br> 
      　　 Cells[4,i]:=‘’;<br> 
      　　 Cells[5,i]:=‘’;<br> 
      　　 end;<br> 
      　　 RowCount:=2;<br> 
      　　 end;<br> 
      　　 Button2.Enabled:=False;<br> 
      　　 Button3.Enabled:=False;<br> 
      　　end;<br>
      　　procedure TForm1.NMSMTP1Failure(Sender: TObject);<br> 
      　　begin<br>
      　　 StatusBar1.SimpleText:=‘Mail send failure!’;<br> 
      　　end;<br>
      　　procedure TForm1.NMSMTP1SendStart(Sender: TObject);<br> 
      　　begin<br>
      　　 StatusBar1.SimpleText:=‘Now Sending...’;<br> 
      　　end;<br>
      　　procedure TForm1.NMSMTP1Success(Sender: TObject);<br> 
      　　begin<br>
      　　 StatusBar1.SimpleText:=‘Send Success!’;<br> 
      　　end;<br>
      　　end.<br>
      　　Button1是“New Mail”按钮，Button 2是“Send”按钮，Button3是“Clear” 按钮。<br> 
      　　以下是Unit2代码清单：<br>
      　　unit Unit2;<br> 
      　　interface<br>
      　　uses<br>
      　　 Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms,&nbsp;<br>
     Dialogs, StdCtrls;<br> 
      　　type<br>
      　　 TForm2 = class(TForm)<br> 
      　　 OpenDialog1: TOpenDialog;<br> 
      　　 GroupBox1: TGroupBox;<br> 
      　　 GroupBox2: TGroupBox;<br> 
      　　 Edit1: TEdit;<br> 
      　　 Edit2: TEdit;<br> 
      　　 Edit3: TEdit;<br> 
      　　 Edit4: TEdit;<br> 
      　　 Edit5: TEdit;<br> 
      　　 Button1: TButton;<br> 
      　　 Button2: TButton;<br> 
      　　 Button3: TButton;<br> 
      　　 Label1: TLabel;<br> 
      　　 Label2: TLabel;<br> 
      　　 Label3: TLabel;<br> 
      　　 Label4: TLabel;<br> 
      　　 Label5: TLabel;<br> 
      　　 Label6: TLabel;<br> 
      　　　procedure Button1Click(Sender: TObject);<br> 
      　　 procedure Button2Click(Sender: TObject);<br> 
      　　 procedure Button3Click(Sender: TObject);<br> 
      　　 procedure FormActivate(Sender: TObject);<br> 
      　　 procedure FormCreate(Sender: TObject);<br> 
      　　 private<br> 
      　　 { Private declarations }<br> 
      　　 public<br> 
      　　 { Public declarations }<br> 
      　　 end;<br> 
      　　var<br>
      　　 Form2: TForm2;<br> 
      　　implementation<br>
      　　uses Unit1;<br> 
      　　{＄R ＊.DFM}<br> 
      　　procedure TForm2.FormCreate(Sender: TObject);<br> 
      　　begin<br>
      　　 self.Caption:=‘New Mail’;&nbsp;<br>
      　　 self.BorderStyle:=bsDialog;<br> 
      　　end;<br>
      　　procedure TForm2.FormActivate(Sender: TObject);<br> 
      　　begin<br>
      　　 Edit1.Text:=‘’;<br> 
      　　 Edit2.Text:=‘’;<br> 
      　　 Edit3.Text:=‘’;<br> 
      　　 Edit4.Text:=‘’;<br> 
      　　 Edit5.Text:=‘’;<br> 
      　　 Label1.Caption:=‘No File’;<br> 
      　　end;<br>
      　　procedure TForm2.Button1Click(Sender: TObject);<br> 
      　　begin<br>
      　　 if OpenDialog1.Execute then<br> 
      　　 Label1.Caption:=Opendialog1.Filename;<br> 
      　　end;<br>
      　　procedure TForm2.Button2Click(Sender: TObject);<br> 
      　　var<br>
      　　i:Integer;<br>
      　　begin<br>
      　　 if (Edit1.Text&lt;>‘’) and (Edit2.Text&lt;>‘’) and (Edit5.Text&lt;>‘’)&nbsp;<br>
      and (Label1.Caption&lt;>‘No File’) then<br> 
      　　 begin<br> 
      　　 with Form1.StringGrid1 do<br> 
      　　 begin<br> 
      　　 RowCount:=RowCount＋1;<br> 
      　　 i:=RowCount－2;<br> 
      　　 Cells[0,i]:=Edit1.Text;<br> 
      　　 Cells[1,i]:=Edit2.Text;<br> 
      　　 Cells[2,i]:=Edit5.Text;<br> 
      　　 Cells[3,i]:=Edit3.Text;<br> 
      　　 Cells[4,i]:=Edit4.Text;<br> 
      　　 Cells[5,i]:=Label1.Caption;<br> 
      　　 end;<br> 
      　　 Form1.Button2.Enabled:=True;<br> 
      　　 Form1.Button3.Enabled:=True;<br> 
      　　 end;<br> 
      　　 self.Hide;<br> 
      　　end;<br>
      　　procedure TForm2.Button3Click(Sender: TObject);<br> 
      　　begin<br>
      　　 self.Hide;&nbsp;<br>
      　　end;<br>
      　　end.<br>
      　　Edit1、Edit2、Edit3、Edit4、Edit5编辑框分别用于填写服务器名称、收件人地址、发件人名称、邮件主题和发件人地址。<br>
      　　现在一个E－mail发送程序就完成了。你可以试一试，自已给自已发几封邮件，用FoxMail之类的软件是否能收到信。顺便说一句，本文就是用这个自编程序发到编辑部的。<br>
    </td>    
  </tr>    
</table>    
</center></div>    
<p>　</p>

</body>

</html>
