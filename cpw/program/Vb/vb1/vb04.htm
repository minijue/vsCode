<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0056)http://www.computerworld.com.cn/99/week/9941/9941b13.asp -->
<HTML><HEAD><TITLE>计算机世界:VB对低层硬件访问控制</TITLE><LINK href="vb2.files/style.css" 
rel=stylesheet type=text/css>
<META content="text/html; charset=gb2312" http-equiv=Content-Type><!--***********-->
<META content="Microsoft FrontPage 4.0" name=GENERATOR></HEAD>
<BODY bgColor=#ffffff>
<div align="center"><center>

<table border="1" cellspacing="0" cellpadding="2" width="100%" style="font-size: 9pt"
bordercolor="#000000" bordercolordark="#FFFFFF">
  <tr bgcolor="#CCFFCC">
    <td><span style="font-size: 9pt">您现在的位置是： <b><a href="../../progidx.htm">编程技巧 
      </a> --&gt; <a href="../Vbidx099.htm">Visual BAsic</a></b></span></td>    
  </tr>    
</table>    
</center></div><div align="center"><center>    
    
<table border="1" width="100%" style="font-size: 9pt" bgcolor="#FFFFFF"    
bordercolor="#000000" cellpadding="2" cellspacing="0" bordercolordark="#FFFFFF">    
  <tr>    
    <td width="85%" align="left" valign="top"><table border="1" width="32%" style="font-size: 9pt" height="30"    
    cellspacing="0" cellpadding="2" bgcolor="#FFFFFF" bordercolor="#000000"    
    bordercolordark="#FFFFFF">    
      <tr>    
        <td width="100%" bgcolor="#4264B5"><p align="center"><span style="font-size: 9pt"><font    
        color="#FFFFFF">资料整理&middot;<a href="http://chinaprog.yeah.net" target="_blank"    
        style="color: rgb(255,255,255)">中国程序员网站</a></font></span></td>    
      </tr>    
    </table>    
      <p align="center"><b>VB 对 低 层 硬 件 访 问 控 制</b>
      <P>VB 没 有 提 供 直 接 访 问 低 层 硬 件 的 控 件 和 方 法，  
      一 度 给 对 访 问 硬 件 感 兴 趣 的 编 程 者 带 来 不 便。 目 前 我 们 可 从 网 上 搜 索 到 支 持 低 层 硬 件 访  
      问 的DLL 和ActiveX 控 件， 通 过 它 们 可 读 写 存 储 器 单 元、 端 口， 甚 至 控 制 硬 件 中 断。 下 面 通  
      过 两 个 利 用DLL 和ActiveX 控 件 示 例 介 绍VB 对 低 层 硬 件 的 访 问 控 制。 
      <H3>一、 利 用DLL 读 写 端 口</H3><BR><FONT color=#ffffff>----</FONT>若 在  
      应 用 程 序 中 只 是 简 单 地 读 写 端 口， 利 用DLL 编 程 实 现 较 为 简 便。  
      从http://personal.vsnl.com/sr 网 站 可 下 载 一 个 免 费 的32 位VBIO.DLL， 该 连 接 库 允 许  
      在VB4、5 或6 中 使 用， 共 有 七 个 函 数 和 过 程, 分 别 为: <PRE>Anjan            DLL 的 解 锁 过 程
Inp              端 口 读 字 节 函 数
Inpw             端 口 读 字 函 数
Out              端 口 写 字 节 过 程
Outw             端 口 写 字 过 程
GetLptBaseAddr    获 取 并 口 基 地 址 的 函 数
GetComBaseAddr   获 取 串 口 基 地 址 的 函 数
</PRE> 
      <P><FONT color=#ffffff>----</FONT>图1 是 一 个 发 声 示 例 程 序 的 窗 体， 在 输 入 框 中 键  
      入 一 频 率 值 并 按SoundOn 钮， 则 在PC 机 的 扬 声 器 中 发 出 指 定 频 率 音 调， 程 序 中 对 音 调 的 变  
      化、 声 音 的 开 关 是 用VBIO.DLL 的 过 程 和 函 数 访 问 发 声 系 统 的 定 时 器/ 计 数 器 和 控 制 端 口  
      实 现 的。 编 程 要 点：1. 应 在Form _Load 中 加 入Anjan 解 锁 过 程。2. 若 在 模 块 中 声 明 函 数 和  
      过 程， 应 去 掉private 或 用Public 替 代。3.VBIO.DLL 应 拷 贝 到 \windows\system 子 目 录  
      下。  
      <P> 
      <IMG src="1784700.jpg" width="340" height="205"> 
      <P><FONT color=#ffffff>----</FONT><B>程 序 清 单：</B> <p>Option 
      Explicit<br>
      Private Declare Sub Anjan Lib&nbsp;<br>
      “vbio.dll&quot; ()<br>
      Private Declare Function Inp Lib&nbsp;<br>
      “vbio.dll&quot; (ByVal port ＆) As Integer<br>
      Private Declare Function Inpw Lib&nbsp;<br>
      “vbio.dll&quot; (ByVal port ＆) As Long<br>
      Private Declare Sub Out Lib&nbsp;<br>
      “vbio.dll&quot; (ByVal port ＆, ByVal byt ％)<br>
      Private Declare Sub Outw Lib<br>
      “vbio.dll&quot; (ByVal port ＆, ByVal wrd ＆)<br>
      Private Declare Function GetLptBaseAddr Lib&nbsp;<br>
      “vbio.dll&quot; (ByVal lpt ＆) As Integer<br>
      Private Declare Function GetComBaseAddr Lib&nbsp;<br>
      “vbio.dll&quot; (ByVal com ＆) As Integer<br>
      <br>
      Public Sub SetFreq(soundHz As Integer) ' 设 置 频 率<br>
      &nbsp;&nbsp;&nbsp; If soundHz Then<br>
      &nbsp;&nbsp;&nbsp; Dim divisor As Long<br>
      &nbsp;&nbsp;&nbsp; divisor = 1193180 / soundHz&nbsp; ' 计 算 时 间 常 
      数<br>
      &nbsp;&nbsp;&nbsp; Out ＆H42, ＆HB6&nbsp;&nbsp;&nbsp;<br>
      &nbsp;&nbsp;&nbsp; '8253 －5 通 道2 设 置 为 方 式3<br>
      &nbsp;&nbsp;&nbsp; Out ＆H42, divisor Mod 256&nbsp; ' 送 时 间 常 数<br>
      &nbsp;&nbsp;&nbsp; Out ＆H42, divisor \ 256&nbsp;&nbsp;&nbsp; '<br>
      &nbsp;&nbsp;&nbsp; Speaker True<br>
      &nbsp;&nbsp;&nbsp; Else<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Speaker False<br>
      &nbsp;&nbsp;&nbsp; End If<br>
      End Sub<br>
      <br>
      Public Sub Speaker(sOn As Boolean)&nbsp; ' 开 关 声 音<br>
      &nbsp;&nbsp;&nbsp; Dim portVal As Integer<br>
      &nbsp;&nbsp;&nbsp; portVal = Inp( ＆H61)&nbsp;&nbsp;&nbsp;<br>
      &nbsp;&nbsp;&nbsp; If sOn Then<br>
      &nbsp;&nbsp;&nbsp; portVal = portVal Or 3<br>
      &nbsp;&nbsp;&nbsp; ' 低 位 为 通 道2 的 门 控 信 号<br>
      &nbsp;&nbsp;&nbsp; Else&nbsp; ' 次 低 位 为 整 形 与 门 控 制 
      信 号<br>
      &nbsp;&nbsp;&nbsp; portVal = portVal And (Not 3)<br>
      &nbsp;&nbsp;&nbsp; End If<br>
      &nbsp;&nbsp;&nbsp; Out ＆H61, portVal<br>
      &nbsp;&nbsp;&nbsp;<br>
      End Sub<br>
      <br>
      Private Sub Form_Load()<br>
      Anjan&nbsp; ' 软 件 解 锁<br>
      End Sub<br>
      <br>
      Private Sub SoundOff_Click()<br>
      Speaker False<br>
      End Sub<br>
      <br>
      Private Sub SoundOn_Click()<br>
      SetFreq Val(TextHz)<br>
      End Sub<br>
</p>
      <H3>二、 利 用ActiveX 处 理 硬 件 中 断</H3><BR><FONT  
      color=#ffffff>----</FONT>在 应 用 程 序 中 如 果 需 要 访 问 存 储 单 元、 端 口 以 及 处 理 硬 件  
      中 断， 使 用TVicHW32 ActiveX 控 件 是 一 很 好 的 选 择， 该 控 件 是 一 个 共 享 软 件， 支  
      持Windows 95/98/NT， 可 从 http://www.entechtaiwan.com/tools.htm 处 下 载。 该 控 件  
      除 具 备 直 接 访 问 存 储 单 元 和 端 口 的 功 能 外， 还 提 供 了 丰 富 的 处 理 并 口 的 属 性 和 方 法， 以  
      及 处 理 硬 件 中 断 的 属 性、 方 法 和 事 件， 极 大 地 拓 展 了VB 对 低 层 硬 件 的 访 问 控 制。 下 面 通 过  
      一 个 显 示 键 盘 中 断 次 数 和 按 键 扫 描 码 的 示 例 介 绍 控 件 的 使 用 过 程。  
      <OL> 
        <LI>下 载TVicHW32 压 缩 软 件 包 并 解 压 到 一 个 目 录 中， 如\HW。 把 driver 子 目 录 下  
        的vichw00.vxd 文 件 拷 贝 到\windows\system 子 目 录 下， 该 文 件 是 控 件 访 问 硬 件 的 驱 动  
        程 序， 使 用 控 件 前 先 用OpenDriver 打 开， 最 后 用Close_Driver 方 法 关 闭。  
        <LI>把ocx 子 目 录 下 的tvichw32.ocx 拷 贝 到\windows\system 子 目 录 下， 并 在 DOS 命 令  
        行 状 态 下 键 入 以 下 命 令 进 行 注 册： <BR><FONT color=#ffffff>----</FONT>regsvr32  
        tvichw32.ocx  
        <LI>在VB 环 境 下 通 过 菜 单 工 程 － － 部 件 － － 控 件 并 选 择TVicHW32 ActiveX Control  
        Module 将 控 件 添 加 到 工 具 箱 中。  
        <LI>相 关 的 属 性、 方 法 及 事 件</LI></OL><p>  &nbsp; 方 
      法&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OpenDriver&nbsp;&nbsp; 打 
      开 支 持 访 问 硬 件<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
      的 驱 动 程 序vichw.vxd（windows95 下）<br>
      &nbsp; 方 法&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CloseDriver&nbsp; 
      关 闭 驱 动 程 序<br>
      &nbsp; 属 性&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ActiveHW As 
      Bool&nbsp; 驱 动 程 序 打 开&nbsp;<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
      则 为True; 关 闭 为False<br>
      &nbsp; 中 断 事 件&nbsp; OnHwInterrupt(ByVal HwCounter As Long,&nbsp;<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
      ByVal LPT_DataReg As Integer,&nbsp;<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 　 　ByVal 
      LPT_StatusReg As Integer,&nbsp;<br>
      &nbsp;　 　&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ByVal 
      ScanCode As Integer<br>
      &nbsp;　 　)<br>
      &nbsp;　 　 参 数<br>
      &nbsp;　 HwCounter&nbsp;&nbsp;&nbsp;&nbsp; : 中 断 次 数<br>
      &nbsp;&nbsp;&nbsp; LPT_DataReg&nbsp;&nbsp; : 如 果 使 用IRQ7，&nbsp;<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
      则 为 打 印 并 口 的 数 据<br>
      &nbsp;&nbsp;&nbsp; LPT_StatusReg&nbsp; : 如 果 使 用IRQ7，&nbsp;<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
      则 为 打 印 并 口 的 数 据<br>
      &nbsp;&nbsp;&nbsp; ScanKode&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 如 果 使 
      用IRQ1，&nbsp;<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
      则 为 按 键 的 扫 描 码<br>
      &nbsp;&nbsp;&nbsp; 属 性&nbsp; IRQNumber 指 定 中 断 号，&nbsp;<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 范 围IRQ1 
      － －15<br>
      &nbsp;&nbsp;&nbsp; 属 性&nbsp; IRQMasked 中 断 非 屏 蔽 则 为True；<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 屏 蔽 为False。<br>
</p>
      <P><FONT color=#ffffff>----</FONT>图2 是 示 例 的 窗 体， 程 序 运 行 后 首 先 按  
      Open_Driver 钮 打 开 驱 动 程 序， 然 后 选 择Unmarsk 复 选 框 开 放 中 断， 此 时 每 按 一 次 键 框 中  
      分 别 显 示 该 键 的 扫 描 码 和 中 断 次 数。 处 理 其 他 中 断 只 需 更 改 中 断 号 即 可（ 中 断 号1 ―15）。  
 
      <P> 
      <IMG src="1784701.jpg" width="340" height="166"> 
      <P><FONT color=#ffffff>----</FONT>程 序 清 单： <p>Public Sub 
      ShowButtons()<br>
      &nbsp;&nbsp; Open_Driver.Enabled = Not HwCtrl.ActiveHW<br>
      &nbsp;&nbsp; Close_Driver.Enabled = HwCtrl.ActiveHW<br>
      &nbsp;&nbsp; B_Unmask.Enabled = HwCtrl.ActiveHW<br>
      End Sub<br>
      <br>
      Private Sub Form_Load()<br>
      ShowButtons<br>
      End Sub<br>
      <br>
      Private Sub Open_Driver_Click()<br>
      &nbsp; HwCtrl.OpenDriver&nbsp; ' 打 开 驱 动 程 序<br>
      &nbsp; If Not HwCtrl.ActiveHW Then<br>
      &nbsp;&nbsp;&nbsp; MsgBox (“The driver VICHWxx not found&quot;)<br>
      &nbsp; Else:<br>
      &nbsp;&nbsp;&nbsp; HwCtrl.IRQNumber = 1&nbsp; ' 中 断 号 为1, 键 盘 
      中 断<br>
      &nbsp; End If<br>
      &nbsp; ShowButtons<br>
      End Sub<br>
      <br>
      Private Sub Close_Driver_Click()<br>
      &nbsp;HwCtrl.CloseDriver&nbsp; ' 关 闭 驱 动 程 序<br>
      &nbsp;B_Unmask.Value = 0<br>
      &nbsp;ShowButtons<br>
      End Sub<br>
      <br>
      Private Sub B_Unmask_Click()<br>
      &nbsp;If B_Unmask.Value = 0 Then<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HwCtrl.IRQMasked = True<br>
      &nbsp;&nbsp;&nbsp; Else<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HwCtrl.IRQNumber = 1<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Scan_Code = 0<br>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HwCtrl.IRQMasked = False ' 开 
      放 中 断<br>
      &nbsp;&nbsp;&nbsp; End If<br>
      End Sub<br>
      <br>
      Private Sub HwCtrl_OnHwInterrupt<br>
      (ByVal HwCounter As Long, ByVal LPT_DataReg As Integer, <br>
      ByVal LPT_StatusReg As Integer, ByVal ScanCode As Integer)<br>
      &nbsp;Scan_Code.Caption = ScanCode<br>
      &nbsp;IRQC.Caption = HwCounter<br>
      End Sub
</p>    
      <p>　    
    </td>    
  </tr>    
</table>    
</center></div>    
</BODY></HTML>
