<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb_2312-80">
<meta name="GENERATOR" content="Microsoft FrontPage 3.0">
<title></title>
</head>

<body bgcolor="#8080C0">
<div align="center"><center>

<table border="1" cellspacing="0" cellpadding="2" width="95%" style="font-size: 9pt"
bordercolor="#000000" bordercolordark="#FFFFFF">
  <tr bgcolor="#CCFFCC">
    <td><span style="font-size: 9pt">您现在的位置是： <b><a href="Vcidx098.htm">Visual 
    C++/C++</a> --&gt;</b> MFC邮递表的中文翻译(第三十七期)</span></td>
  </tr>
</table>
</center></div><div align="center"><center>

<table border="1" width="95%" style="font-size: 9pt" bgcolor="#FFFFFF"
bordercolor="#000000" cellpadding="2" cellspacing="0" bordercolordark="#FFFFFF">
  <tr>
    <td width="100%"><table border="1" width="32%" style="font-size: 9pt" height="30"
    cellspacing="0" cellpadding="2" bgcolor="#FFFFFF" bordercolor="#000000"
    bordercolordark="#FFFFFF">
      <tr>
        <td width="100%" bgcolor="#4264B5"><p align="center"><font color="#FFFFFF">资料整理<span
        class="f">&middot;</span><a href="http://chinaprog.yeah.net" target="_blank"
        style="color: rgb(255,255,255)">中国程序员网站</a></font></td>
      </tr>
    </table>
    </td>
  </tr>
  <tr>
    <td width="100%">　<h2 align="center"><span style="font-size: 9pt">MFC邮递表的中文翻译</span></h2>
    <p>&nbsp;&nbsp;&nbsp;&nbsp;我是一名mfc程序设计的爱好者,订阅了mfc的maillist,利用业余时间 
    将它翻译出来,希望能对mfc编程的朋友有所帮助,请朋友们指正.<br>
    </p>
    <h3><font color="#FF0000">第三十七期目录</font> <fontsize="2">杨晓东 1999.5.11</h3>
    <ol>
      <li><a href="#volq1">删除字体</a> </li>
      <li><a href="#volq2">关于dllimport的问题</a> </li>
      <li><a href="#volq3">CObject的多重继承</a> </li>
      <li><a href="#volq4">将两个程序打包成一个</a> </li>
      <li><a href="#volq5">改变一个列表控件中的字体</a> </li>
      <li><a href="#volq6">MFC42.DLL Windows NT4.0 SP4 和 Windows 98</a> </li>
      <li><a href="#volq7">在多行CEdit控件中显示一个分页符</a> </li>
      <li><a href="#volq8">CString.Find()出错.</a> </li>
      <li><a href="#volq9">用文本填充CRichEditView的问题</a> </li>
      <li><a href="#volq10">数据库</a> </li>
    </ol>
    <p><a name="volq1"></a></p>
    <p><br>
    </p>
    <font color="Red"><h3>删除字体</h3>
    </font><p>问：假定我已经建立了一个CFont对象，然后用它来设置在对话框中的字体，怎样才能 
    在我使用之后安全的删除它？（以下为程序片段） </p>
    <pre>        CFont* pFont = new CFont();
        // tempLogFontStructure is a LOGFONT structure that I've defined
//somewhere
        pDlgFont-&gt;CreateFontIndirect(&amp;tempLogFontStructure);
        // nID is the ID of the control I wish to update
        GetDlgItem(nID)-&gt;SetFont(pFont, TRUE);
        // retain CFont pointer - store it in member variable
        m_pFont = pFont;</pre>
    <p>当任务完成后我想删除该字体，以释放该对象所占用的内存，可是只是一运行 
    &quot;delete m_pFont&quot;，问题就一个接着一个。有谁能帮助我？</p>
    <p>答：1)应该在删除窗口之后进行，最好的位置是显而易见的，在对话框的析构函数中。</p>
    <p>2)你有没有忘记用SelectObject来增加一个字体，并保存老的字体？</p>
    <p>3)你必须通知控件，你已经不再使用这个字体了，可以将你控件的字体设置为某一系统 
    字体来完成。 </p>
    <pre>// set private font
pCtrl-&gt;SetFont(pMyFont);

// ... use it

// reset
pCtrl-&gt;SetFont(CFont::FromHandle((HFONT) ::GetStockObject(SYSTEM_FONT)));</pre>
    <p>4)将变量m_pFont定义为对话框类的一个成员，因为它的生命周期与对话框一样，删除它时 
    在析构函数中进行。</p>
    <a href="#PageBegin"><p align="right">回到本期目录</a><br>
    </p>
    <p><a name="volq2"></a><br>
    </p>
    <font color="Red"><h3>关于dllimport的问题</h3>
    </font><p>问：在使用VC6时，从一个DLL程序中调用函数时遇上了如下几个问题。 
    *我将所有的DLL文件全部拷入debug目录中,也将相应的设置改变了. * 
    但编译器依然不承认下面这条语句: </p>
    <pre> __declspec (dllimport) HIMG SCTAPI ImgLoad(char SCTPTR pcName);

2 errors:
C2146: Syntax error: missing ; before SCTAPI
C1004: unexpected end of file found</pre>
    <p>* 如果我这样声明 </p>
    <pre>extern &quot;C&quot; __declspec (dllimport) HIMG SCTAPI ImgLoad(char SCTPTR pcName);</pre>
    <p>就会有三个错误,包括上面2个以及: </p>
    <pre>C2501 HIMG: missing storage class or type specification.</pre>
    <p>*另外,我也试过改变Debug的设置加入4个DLL文件,没有用.</p>
    <p>答：看上去HIMG声明没有被编译器所识别,你有没有加入相应的头文件?</p>
    <a href="#PageBegin"><p align="right">回到本期目录</a><br>
    </p>
    <p><a name="volq3"></a><br>
    </p>
    <p>CObject的多重继承 问：为什么不能多重继承CObject类：我的继承关系如下： 
    </p>
    <pre>                            CObject
                             /
CObject             CFluid
     \                   /
     CPSD       CSlurry
        \             /
     CSuspension</pre>
    <p>答：使用虚继承类可以解决你的问题<br>
    </p>
    <pre>#include <AfxWin.h>
#include <TChar.h>
#pragma hdrstop

class CPSD : virtual public CObject
{
};

class CFluid : virtual public CObject
{
};

class CSlurry : public CFluid
{
};

class CSuspension : public CPSD, public CSlurry
{
};

extern &quot;C&quot; void _tmain ()
{
        CSuspension mySuspension;
}</pre>
    <a href="#PageBegin"><p align="right">回到本期目录</a><br>
    </p>
    <p><a name="volq4"></a><br>
    </p>
    <font color="Red"><h3>将两个程序打包成一个</h3>
    </font><p>问:我有几个程序分布在客户机中,我需要增加一个模块来增加对用户的判别.用户每次 
    运行这个程序时都先运行这个程序.而这几个程序不是用VC开发的,所以我想法将这些 
    程序与我的代码打包成一个.exe文件,如何实现它?</p>
    <p>答：1）简单的说,将老的程序作为一个二进制资源插入到你的程序中,然后先执行你的需要，再 
    将这个二进制资源作为一个可执行文件写到磁盘上，然后再执行这个程序。同样的方法， 
    你也可以加两个程序等等。</p>
    <p>2）使用COM就可以完成，但你必须要改写主程序的InitInstance或者ExitInstance。有许多 
    ansi和win32函数可以独立运行你的程序。</p>
    <a href="#PageBegin"><p align="right">回到本期目录</a><br>
    </p>
    <p><a name="volq5"></a><br>
    </p>
    <font color="Red"><h3>改变一个列表控件中的字体</h3>
    </font><p>问：在图标浏览器中我需要改变图标下面的字体，但并不是对所有的文本。在report-view, 
    没有问题，但在icon- view中如何实现，我使用的是vc6.0 nt4.0和98</p>
    <p>答：使用CUSTOMDRAW画出你自己认为适合的，这要做好多工作，但很灵活。 
    为需要改变的项目增加TVIS_BOLD类型，注意只在自定义ListCtrl中支持。</p>
    <a href="#PageBegin"><p align="right">回到本期目录</a><br>
    </p>
    <p><a name="volq6"></a><br>
    </p>
    <font color="Red"><h3>MFC42.DLL Windows NT4.0 SP4 和 Windows 98</h3>
    </font><p>问：我在开发一个程序时遇上了一个问题，前不久，我还在使用VC++5（没有使用升级包）， 
    我程序的安装程序没有包括MFC42.DLL，每台电脑上都装过，没有任何问题，现在我用VC6 
    重建了该项目，我却得到了一个错误 </p>
    <pre>Fcaddb.exe is linked to a missing export MFC42.DLL : 6880</pre>
    <p>答：1）这是一大家都可能遇得上的问题，你应该将程序中使用到的DLL全部打包，并不是所有 
    的程序都可以打包，那些文件可以打包可以看一下VC++CD中的REDISTRIBUTE.RTF/REDISTRIB.RTF 
    有些DLL需要注册方可使用，这就需要在安装程序完成注册。</p>
    <p>2）为什么你不使用静态联接动态联接库，可以解决因版本不同带来的问题。</p>
    <a href="#PageBegin"><p align="right">回到本期目录</a><br>
    </p>
    <p><a name="volq7"></a><br>
    </p>
    <font color="Red"><h3>在多行CEdit控件中显示一个分页符</h3>
    </font><p>问：我想对一个多行CEdit控件进行一下改造，使它能在满页的时候显示一个虚线， 
    我已经知道分页符出现的位置，但我不知道怎样将分页符放置在文本中?p&gt;?答：这样做 
    </p>
    <pre>CEdit::SetSel(i,i);
CEdit::ReplaceSel(&quot;\r\n-----\r\n&quot;);</pre>
    <p>i是一个字符，可以替换掉，如果你得到象|-----| 这样，又是在两个\r\n或\n\r中间，注意 
    这样做你就不能显示字符i，它将会被代替。</p>
    <a href="#PageBegin"><p align="right">回到本期目录</a><br>
    </p>
    <p><a name="volq8"></a><br>
    </p>
    <font color="Red"><h3>CString.Find()出错.</h3>
    </font><p>问:当我调用CString 的成员函数&quot;Find&quot;,带了一个参数.编译器提示出错. 
    error C2661: 'Find' : no overloaded function takes 2 parameters 我使用的例子是从MSDN下来的 
    </p>
    <pre>CString::Find( TCHAR ch, int nStart )</pre>
    <p>答：要使得这个成员函数带有两个参数,可以自己完成:（VC5中只支持一个参数）</p>
    <pre> int SuperFind(int iFrom, const CString *pszValue, char chChar)
 {
 CString szTemp;
 int iTemp;

 szTemp = pszValue-&gt;Mid(iFrom);

 iTemp = szTemp.Find(chChar);

 return iTemp;
 }</pre>
    <a href="#PageBegin"><p align="right">回到本期目录</a><br>
    </p>
    <p><a name="volq9"></a><br>
    </p>
    <font color="Red"><h3>用文本填充CRichEditView的问题</h3>
    </font><p>问:我想做些非常简单的事情（我是这么认为的），我有一个CSring,是一段文字中的几行, 
    (分隔是由回车符完成的)现在我想将这段文本放置在我的CRichEditView中的RichEditCtrl 
    以显示,但无论我如何试,只是显示该段文字的第一行.</p>
    <p>答:请在RichEditCtrl中使用ES_MULTILINE和WS_VSCROLL类型,然后调用SetWindowText() 
    来显示文本.</p>
    <a href="#PageBegin"><p align="right">回到本期目录</a><br>
    </p>
    <p><a name="volq10"></a><br>
    </p>
    <font color="Red"><h3>数据库</h3>
    </font><p>问：数据库中有一个二进制字段，我用一个从CRecordset类继承的一个类来操作这个数据库， 
    这个字段声明为CLongBinary变量。但每次插入或增加一个记录，CLongBinary 
    总会多分配到 一些内存，释放所有分配的内存之后再调用Update()，但内存前后不一致。为什么？ 
    使用这个函数，将会解决你提出来的问题。 </p>
    <pre>void CopyLongBinary(CLongBinary&amp; lbSrc, CLongBinary&amp; lbDest, CRecordset
* pRecordset )
{
    ASSERT_VALID( pRecordset );

    UINT nLen;
    HGLOBAL hGlob;
    LPSTR lpStr;
    char * pStrWithNull;

    // Read it from the src
    nLen = (UINT)lbSrc.m_dwDataLength;
    if ( nLen )
    {
        lpStr = (LPSTR)GlobalLock( lbSrc.m_hData );

        // Throws exception if needed
        pStrWithNull = new char[nLen+1];

        memcpy( pStrWithNull, lpStr, nLen );
        pStrWithNull[nLen] = 0;    // Set '\0' at end of string

        hGlob = GlobalAlloc( GPTR | GMEM_SHARE, (DWORD)nLen );
        if ( !hGlob )
        {
            AfxThrowMemoryException();
        }
        lpStr = (LPSTR)GlobalLock( hGlob );
        if ( !lpStr )
        {
            GlobalFree( hGlob );
            AfxThrowMemoryException();
        }

        // Cut off the null
        memcpy( lpStr, pStrWithNull, nLen );

        GlobalUnlock( hGlob );    // Don't leave it locked.

        delete [] pStrWithNull;
        GlobalUnlock( lbSrc.m_hData );
    }
    else // Empty
    {
        nLen = 0;
        hGlob = NULL;
    }

    // Free memory we are replacing
    GlobalUnlock( lbDest.m_hData );
    GlobalFree( lbDest.m_hData );

    // Put in new data
    lbDest.m_dwDataLength = (DWORD) nLen;
    lbDest.m_hData = hGlob;

    if (lbDest.m_dwDataLength == 0)
    {
        if ( pRecordset-&gt;IsFieldNullable(&amp;lbDest) )
            pRecordset-&gt;SetFieldNull( &amp;lbDest, TRUE);
    }
    else
    {
        // It is required that we explicitly set it Dirty
        // and NOT Null
        pRecordset-&gt;SetFieldNull( &amp;lbDest, FALSE );
        pRecordset-&gt;SetFieldDirty( &amp;lbDest, TRUE );
    }
}</pre>
    <a href="#PageBegin"><p align="right">回到本期目录</a><br>
    </p>
    <hr>
    <a href="cmfcv38.htm"><p align="center">前一期</a>|<a href="cmfcv36.htm">后一期</a><br>
    <a href="http://mfc2000.yeah.net" target="_top">玉海园</a>[http://mfc2000.yeah.net]友情提供! 
    </td>
  </tr>
</table>
</center></div>

<p><a name="PageBegin"></a></p>
</body>
</html>
