<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>Turbo C修改Auto CAD的图素曲国庆</title>
<meta name="GENERATOR" content="Microsoft FrontPage 3.0">
</head>

<body style="font-size: 9pt" background="../../res/back.JPG">

<table border="0" width="100%" style="font-size: 9pt">
  <tr>
    <td width="100%" align="center"><strong>Turbo C修改Auto CAD的图素</strong></td>
  </tr>
  <tr>
    <td width="100%" align="center">文/曲国庆 录入/江湖小子</td>
  </tr>
  <tr>
    <td width="100%" align="center">1999年8月7日</td>
  </tr>
  <tr>
    <td width="100%" align="center"></td>
  </tr>
</table>

<p>摘要：本文通过分析Auto<br>
CAD数据交换文件的结构，运用C语言直接读写其中的图素，并给出了主要源程序，实现了在DOS下修改Auto 
CAD图素的方法，提高图形编辑的速度。<br>
<br>
关键词：Auto CAD、图素、Turbo C、文件、结构<br>
<br>
Auto<br>
CAD是一套高效的绘图工具，在地图制图和计算机辅助设计方面得到广泛的应用。地籍图的数字化和编辑中，常会遇到图形的放大和缩小等情况，而其中的部分图素则要求保持原样，如界址点的园圈要求无论在何种比例尺地籍图中其半径均为0.4mm，注记也必须满足规范要求。如何在图形比例变化后，复原部分图素的大小，是地籍制图工作中非常重要的问题。本文讨论运用Turbo 
C语言直接读写Auto CAD的数据交换文件并修改其部分图素的方法。<br>
<br>
Auto<br>
CAD图形数据库是以十分紧缩的格式存储的，对用户程序来说，很难直接读出，为便于数据交换，AutoCAD提供了数据交换文件──DXF文件。?此文件是一种专用的ASCII文件，其一般结构为：HEADER（标题）节、?TABLES?（表格）节、BLOCK（块）节、ENTITIES（图素）节、EOF（文件结束）节，共五个部分。每个部分由若干组构成，每个组由两行组成，首行为组代码，其格式为三个字符域向右对齐，左边填满空格，该组的第二行是组值，采用的格式取决于由组代码规定的组的类型。<br>
<br>
部分组代码及其含义：<br>
<br>
0 ──标识一个图素表目的开始；<br>
<br>
1 ──一个图素的初始文本值；<br>
<br>
6 ──线型名；<br>
<br>
8 ──层次名；<br>
<br>
10──起始X坐标（线或正文图素的起始点，园的园心，等等）；<br>
<br>
11-18──其它X坐标；<br>
<br>
20──起始Y坐标（线或正文图素的起始点，园的园心，等等）；<br>
<br>
21-28──其它Y坐标；<br>
<br>
30-38──Z坐标；<br>
<br>
40-48──浮点值（如文字高度、比例因子等）；<br>
<br>
50-58──角度；<br>
<br>
62──颜色号。<br>
<br>
70-78──整数值(如文本注记方式等)<br>
<br>
DXF文件各个节的代码及顺序为：<br>
<br>
0 （开始标题节） 0 （开始图素节） <br>
<br>
SECTION SECTION <br>
<br>
2 2 <br>
<br>
HEADER ENTITIES <br>
<br>
. . （图素部分） <br>
<br>
0 （开始表节） 0 （终止图素） <br>
<br>
SECTOIN ENDSEC <br>
<br>
2 0 （文件结束节） <br>
<br>
TABLES EOF （文件结束） <br>
<br>
. <br>
<br>
0 （开始块节） <br>
<br>
SECTION <br>
<br>
2 <br>
<br>
BLOCKS <br>
<br>
每个图素从标识图素的0开始，分别为图素名、层次组码、层次名等，部分图素的组代码为：<br>
<br>
LINE 10和20（起始点），11和21（终止点）。<br>
<br>
POINT 10和20。<br>
<br>
CIRCLE 10和20（园心），40（半径）。<br>
<br>
ARC<br>
10和20（园心），40（半径），50（起始角度），51（终止角度）。<br>
<br>
TEXT<br>
10和20（插入点），40（高度），1（文字值），50（旋转角度，可选项），41（X的比例因子，可选项），51（倾斜角，可选项），72（对齐类型，可选项），等。<br>
<br>
...<br>
<br>
以上图素均有颜色可选项，若用系统颜色，则此项省略，否则，有组码62和组值（即所用的颜色值）。<br>
<br>
以部分图素为例，其在DXF文件中的结构为：<br>
<br>
0 (图素开始) 11 <br>
<br>
TEXT 31.877698 (终点X值) <br>
<br>
8 21 <br>
<br>
0 (0层) 24.488029 (终点Y值) <br>
<br>
62 31 <br>
<br>
1 (1号颜色) 0.0 (终点Z值) <br>
<br>
10 0 <br>
<br>
14.419423 (插入点X值) CIRCLE <br>
<br>
20 8 <br>
<br>
29.015994 (插入点Y值) 0 (0层) <br>
<br>
30 10 <br>
<br>
0.0 (插入点Z值) 21.021801 (园心X值) <br>
<br>
40 20 <br>
<br>
2.0 (文本高度) 14.931725 (园心Y值) <br>
<br>
1 30 <br>
<br>
asdasf (文本值) 0.0 (园心Z值) <br>
<br>
50 40 <br>
<br>
10.0 (旋转角度值) 2.993616 (半径R值) <br>
<br>
72 0 <br>
<br>
1 (对齐方式) ARC <br>
<br>
11 8 <br>
<br>
20.0 (对齐点X值) 0 <br>
<br>
21 10 <br>
<br>
30.0 (对齐点Y值) 40.578556 (中心X值) <br>
<br>
31 20 <br>
<br>
0.0 (对齐点Z值) 16.275509 (中心Y值) <br>
<br>
0 30 <br>
<br>
LINE 0.0 (中心Z值) <br>
<br>
8 40 <br>
<br>
0 (0层) 6.505316 (半径R值) <br>
<br>
62 50 <br>
<br>
3 (三号颜色) 54.138194 (起点角度值) <br>
<br>
10 51 <br>
<br>
24.333769 (起点X值) 176.45641 (终点角度值) <br>
<br>
20 <br>
<br>
25.039355 (起点Y值) <br>
<br>
30 <br>
<br>
0.0 (起点Z值) <br>
<br>
以修改CIRCLE的半径和TEXT的高度为例。由于大部分图素有可选项，数据结构不固定，因此难以用Turbo 
C的结构体进行读写。另外，DXF文件的组码不是左对齐，也无法按整型数据读取。Turbo 
C提供了两个函数：fgets(str,n,fp)和fputs (str,fp)。前者是从fp指向的文件输入n-1个字符，并把它们放到字符数组str中。<br>
若在读入n-1个字符结束之前遇到换行符或EOF读入结束。后者是把str中的字符输入到fp指向的文件中。设图素的可选项均为系统默认值，源程序如下：<br>
<br>
/*修改DXF文件中的园的半径和TEXT的高度*/<br>
<br>
#include &quot;stdio.h&quot;<br>
<br>
FILE *fp,*fp0;<br>
<br>
main()<br>
<br>
{<br>
<br>
char s1[40],s2[40],s3[40],*ss;<br>
<br>
int i;<br>
<br>
char outfile[12];<br>
<br>
printf(&quot;输入DXF文件名(含扩展名): &quot;);<br>
<br>
scanf(&quot;%s&quot;,outfile);<br>
<br>
if ((fp=fopen(outfile,&quot;r&quot;))==NULL)<br>
<br>
{printf(&quot;can not open file\n&quot;);<br>
<br>
exit(0);<br>
<br>
}<br>
<br>
if ((fp0=fopen(&quot;dxf0.dxf&quot;,&quot;w&quot;))==NULL)<br>
<br>
{printf(&quot;error!\n&quot;);<br>
<br>
exit(0);<br>
<br>
}<br>
<br>
while (! feof(fp))<br>
<br>
{<br>
<br>
fgets(s1,20,fp);fputs(s1,fp0);<br>
<br>
if (s1[0]=='C'&amp;&amp; s1[1]=='I' &amp;&amp; s1[2]=='R')<br>
<br>
{for (i=1;i&lt;=9;i++) {fgets(s1,20,fp);fputs(s1,fp0);}<br>
<br>
fgets(s1,20,fp);<br>
<br>
fputs(&quot;1.4\n&quot;,fp0);<br>
<br>
}<br>
<br>
if (s1[0]=='T'&amp;&amp; s1[1]=='E' &amp;&amp; s1[2]=='X' &amp;&amp; s1[3]=='T')<br>
<br>
{for (i=1;i&lt;=11;i++) {fgets(s1,20,fp);fputs(s1,fp0);}<br>
<br>
fgets(s1,20,fp);fputs(&quot;2.0\n&quot;,fp0);<br>
<br>
}<br>
<br>
}<br>
<br>
fclose(fp);fclose(fp0);<br>
<br>
}<br>
<br>
运行此程序即可将园的半径均修改为0.4，将文本注记的高度均修改为2.0，修改的结果保存到DXF0.DXF中，在Auto 
CAD状态下用DXFIN?命令即可调出修改后的图形。<br>
当可选项为非默认值时，读者可仿照此方法，设计相应的子函数，通过组码及其值的判断完成相应图素的修改。也可以实现交互式编辑。<br>
<br>
此方法在地籍制图的实际工作中，已得到应用，并收到良好的效果，特别在批量修改方面，其优点更为突出。<br>
</p>
</body>
</html>
