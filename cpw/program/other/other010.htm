<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>用Netware SDK开发网络管理系统</title>
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
</head>

<body>

<div align="center"><center>

<table border="1" cellspacing="0" cellpadding="2" width="95%" style="font-size: 9pt"
bordercolor="#000000" bordercolordark="#FFFFFF">
  <tr bgcolor="#CCFFCC">
    <td><span style="font-size: 9pt">您现在的位置是： <b><a href="../progmenu.htm">编程技巧</a> --&gt; 
      <a href="../other/oth_idx.htm">其它</a> --&gt; </b> </span>用Netware  
SDK开发网络管理系统</td> 
  </tr> 
</table> 
</center></div><div align="center"><center> 
 
<table border="1" width="95%" style="font-size: 9pt" bgcolor="#FFFFFF" 
bordercolor="#000000" cellpadding="2" cellspacing="0" bordercolordark="#FFFFFF"> 
  <tr> 
    <td width="100%"><table border="1" width="32%" style="font-size: 9pt" height="30" 
    cellspacing="0" cellpadding="2" bgcolor="#FFFFFF" bordercolor="#000000" 
    bordercolordark="#FFFFFF"> 
      <tr> 
        <td width="100%" bgcolor="#4264B5"><p align="center"><span style="font-size: 9pt"><font 
        color="#FFFFFF">资料整理&middot;<a href="http://chinaprog.yeah.net" target="_blank" 
        style="color: rgb(255,255,255)">中国程序员网站</a></font></span></td> 
      </tr> 
    </table> 
    </td> 
  </tr> 
  <tr> 
    <td width="100%"><span 
style="FONT-FAMILY: 宋体; FONT-SIZE: 9pt; LETTER-SPACING: 1px; LINE-HEIGHT: 20px"> 
 
<p align="center" class="ourfont"></span><strong><font color="#0000ff" size="3"><br> 
 </font><font size="3">用Netware  
SDK开发网络管理系统</font></strong> </p> 
 
<p align="left" class="ourfont"><span 
style="FONT-FAMILY: 宋体; FONT-SIZE: 9pt; LETTER-SPACING: 1px; LINE-HEIGHT: 20px"><font 
color="#000000">&nbsp;&nbsp;&nbsp;</font><font size="2">卢继勇 周玉敏 </font> </span></p> 
 
      <font size="2"> 
 
<p>　　很多程序员都比较熟悉在DOS系统下用C语言编写对Netware服务器进行管理的程序。随着32位操作系统的日益普及，越来越多的人希望能够在Windows  
95或NT环境下开发这些功能，并且希望能够充分利用如VB这类语言的RAD工具的优势。最新的Netware  
SDK考虑到了这些需求，它用不同的方式来支持不同平台和不同开发工具的开发工作。  
</p> 
 
<p>　　1．问题提出 </p>

<p>　　笔者所在的微机实验室的运行环境是Novell 3.12局域网，学生上机所用的软件全部放在服务器上，再根据这学期各班所用软件的不同而授予不同的目录权限，学生在上机时根据自己的需要将软件拷贝到工作站上使用，这样就减轻了机房管理人员的负担。但在管理机房的实际过程中却遇到了不少困难。  
</p> 
 
<p>　　(1)机房管理人员还担负辅导学生、考勤等任务，由于学生人数多、班次多，所以管理起来非常困难；对于机房的设备来说，哪些机器有人用、哪些机器没人用，也很难一目了然。于是，管理人员希望能达到这样的结果：只要学生登录到服务器上，就能看到他的帐号、班级、姓名以及所使用的机器是哪一台。 
</p>

<p>　　(2)一学年结束后，毕业生的帐号、目录需要删除，新生的帐号、目录需要建立。在服务器上，我们为每一个班建一个组，该班学生的帐号就属于这个组，设置帐号目录权限时就只需为每个组设置权限即可。用Netware的实用程序Syscon建立、删除帐号十分繁琐，特别是在建立帐号时，要为每一个帐号设置口令、连接数、安全等效性、使用服务器空间的限制等。如果用实用程序Makeuser建立帐号，则必须先建一底稿文件。管理员希望只输入该班的组名称和人数，就能在服务器上建立该班学生的帐号以及设置相应的权限，从而建立组和每个帐号都有读写权限的目录。 
</p>

<p>　　(3)在学生上机过程中，管理员可以通过控制台对用户发送消息。但这种方式不够灵活，它既不能发中文信息，也不能向其中的部分用户发送信息。因此，管理员希望有一个小应用程序来解决这个问题。 
</p>

<p>　　2．系统实现 </p>

<p>　　由于希望能够在Windows 95平台上完成上述任务，则系统必须能够访问底层的Netware的应用程序接口，也就是Netware  
API。 </p> 
 
<p>　　Netware SDK(Software Development Kit)为程序员开发基于Netware环境的应用程序提供了一整套接口函数，包括链接服务、Bindery服务、目录服务等调用函数，用户可以通过调用这些函数对服务器的Bindery库、目录等进行操作。  
</p> 
 
<p>　　Netware SDK具有多种开发工具的接口，如C语言、Delphi、VB等。因此，用户可以利用这些接口函数开发出DOS、Windows平台的应用程序，本文只讨论在Windows  
95下使用VB 调用Netware API情况。 </p> 
 
<p>　　虽然Windows 95中的Netware网络客户可以顺利地访问Netware服务器，并可以运行大多数的Netware应用程序，但是由于Netware  
SDK使用的API是Netware的专用接口，因此，要使用Netware SDK，首先必须安装Netware  
Client 32，即由Netware提供的32位客户软件，并进行相应的配置。 </p> 
 
<p>　　为了在VB中调用Netware API，SDK提供了几个文本文件，其中包含大部分Netware函数声明以及相应的常数。假如现在需要一个查看Netware服务器信息的功能，则首先要在SDK的文档中查找到符合需要的函数，以了解其功能和各参数的意义，现有一个函数如下：  
</p> 
 
<p>　　NWGetFileServerInformation(conn,serverName,majorVer,minVer,rev,maxConns,maxConnsUsed,connsInUse,numVolumes,SFTLevel,TSLevel); 
</p>

<p>　　该函数的功能是返回服务器的名称、NetWare的版本号、服务器支持的用户链接数以及当前使用的链接数、SFT和TTS的级别，该函数中各参数的意义如下： 
</p>

<p>　　conn （输入）NetWare服务器的链接句柄； </p> 
 
<p>　　ServerName （输出）NetWare服务器的名称； </p> 
 
<p>　　majorVer （输出）NetWare版本的主版本号（可选）； </p> 
 
<p>　　MinVer （输出）NetWare版本的次版本号（可选）； </p> 
 
<p>　　rev （输出）NetWare的修订版本号（可选）； </p> 
 
<p>　　maxConns （输出）服务器所能支持的最大链接数（可选）； </p> 
 
<p>　　maxConnsUsed  
（输出）服务器上正在使用的最大链接数（可选）； </p> 
 
<p>　　ConnsInUse （输出）服务器上允许使用的链接数（可选）； </p> 
 
<p>　　NumVolumes （输出）服务器能支持的最大卷数（可选）； </p> 
 
<p>　　SFTLevel （输出）SFT级别（可选）； </p> 
 
<p>　　TTSLevel （输出）TTS级别（可选）。 </p> 
 
<p>　　使用VB中附带的API浏览器打开相应的包括该函数的nwcalls.txt文件，找到该函数后，将该函数声明及相关常数拷贝粘贴到VB模块中，然后再从自己的程序中调用它。 
</p>

<p>　　3．程序举例 </p>

<p>　　在我们开发的网络管理系统中，有两个需要说明的问题。 </p>

<p>　　(1)在调用其他Netware API函数之前必须先调用函数NWCallsInit来初始化函数底层接口。  
</p> 
 
<p>　　(2)这个子程序的一些函数中用到的输入参数是从另外的子程序中产生的，这些子程序没有列出，只在函数调用处加以说明。 
</p>

<p>　　这个程序是解决上文“问题提出”中第(1)个问题的一段VB代码，关于源代码请访问网点www.pccomputing.com.cn。 
</p>

<p>　　publicsub.bas </p>

<p>　　Option Explicit </p> 
 
<p>　　 Public AccountName(100) As String * 255 </p> 
 
<p>　　 Public Address(100) As String </p> 
 
<p>　　 Public SubNet(100) As String </p> 
 
<p>　　 Public loginTime(100) As String </p> 
 
<p>　　 Public connNum(100) As Integer ' each user's connection No. </p> 
 
<p>　　 Public ConnTotal As Integer ' user's sum </p> 
 
<p>　　 Public ServerHandle As Long 'server's handle </p> 
 
<p>　　Sub GetServerInfo()'该子程序的功能是：取得用户的帐户名、登录时间以及用户工作站的网卡地址、网络地址。  
</p> 
 
<p>　　 Dim i As Integer </p> 
 
<p>　　 Dim code As Long </p> 
 
<p>　　 Dim str As String </p> 
 
<p>　　 Dim maxConns As Integer </p> 
 
<p>　　 Dim strusername As String * 255 </p> 
 
<p>　　 Dim bytelogintime(7) As Byte </p> 
 
<p>　　 Dim intobjtype As Integer </p> 
 
<p>　　 Dim lgobjid As Long </p> 
 
<p>　　 Dim b As Byte </p> 
 
<p>　　 Dim addr As tNWINET_ADDR </p> 
 
<p>　　 Dim temp As String </p> 
 
<p>　　 Dim t As Integer </p> 
 
<p>　　 For i = 0 To 100 </p> 
 
<p>　　 AccountName(i) = &quot;&quot; </p> 
 
<p>　　 Address(i) = &quot;&quot; </p> 
 
<p>　　 SubNet(i) = &quot;&quot; </p> 
 
<p>　　 loginTime(i) = &quot;&quot; </p> 
 
<p>　　 Next </p> 
 
<p>　　 ConnTotal = 0 </p> 
 
<p>　　'输入参数ServerRef是从其他子程序获得，取得的函数是：NWCCScanConnRefs 
</p>

<p>　　 code=NWCCOpenConnByRef(ServerRef,NWCC_OPEN_LICENSED,NWCC_RESERVED,ServerHandle) </p> 
 
<p>　　 If code &lt;&gt; SUCCESS Then </p> 
 
<p>　　 MsgBox&quot;不能打开服务器的连接！&quot; </p> 
 
<p>　　 Exit Sub </p> 
 
<p>　　 End If </p> 
 
<p>　　 code=NWGetFileServerInformation(ServerHandle,str,b,b,b,i,maxConns,i,i,b,b) </p> 
 
<p>　　 If code &lt;&gt; SUCCESS Then </p> 
 
<p>　　 MsgBox &quot;发生错误！&quot; &amp; Hex(code) </p> 
 
<p>　　 Exit Sub </p> 
 
<p>　　 End If </p> 
 
<p>　　 For i = 0 To maxConns </p> 
 
<p>　　  
code=NWGetConnectionInformation(ServerHandle,i,strusername,intobjtype,lgobjid,bytelogintime(0))  
</p> 
 
<p>　　 If code = SUCCESS Then </p> 
 
<p>　　 '获取用户的帐号 </p> 
 
<p>　　 strusername = Left$(strusername, InStr(1, strusername, vbNullChar) - 1) </p> 
 
<p>　　 AccountName(ConnTotal) = RTrim(strusername) </p> 
 
<p>　　 '取得用户登录在服务器上的链接号 </p> 
 
<p>　　 connNum(ConnTotal) = i </p> 
 
<p>　　 '取得用户工作站的网卡地址和网络地址 </p> 
 
<p>　　 code = NWGetInetAddr(ServerHandle, i, addr) </p> 
 
<p>　　 If code = SUCCESS Then </p> 
 
<p>　　 temp = &quot;&quot; </p> 
 
<p>　　 For t = 0 To 5 </p> 
 
<p>　　 temp = Trim(Hex(addr.netNodeAddr(t))) </p> 
 
<p>　　 If Len(temp) = 1 Then </p> 
 
<p>　　 temp = &quot;0&quot; &amp; temp </p> 
 
<p>　　 End If </p> 
 
<p>　　 Address(ConnTotal) = Address(ConnTotal) &amp; temp </p> 
 
<p>　　 Next </p> 
 
<p>　　 temp = &quot;&quot; </p> 
 
<p>　　 For t = 0 To 3 </p> 
 
<p>　　 temp = Trim(Hex(addr.networkAddr(t))) </p> 
 
<p>　　 If Len(temp) = 1 Then </p> 
 
<p>　　 temp = &quot;0&quot; &amp; temp </p> 
 
<p>　　 End If </p> 
 
<p>　　 SubNet(ConnTotal) = SubNet(ConnTotal) &amp; temp </p> 
 
<p>　　 Next </p> 
 
<p>　　 End If </p> 
 
<p>　　 '获取用户的登录时间 </p> 
 
<p>　　 For t = 3 To 5 </p> 
 
<p>　　 loginTime(ConnTotal) = loginTime(ConnTotal) &amp; bytelogintime(t) </p> 
 
<p>　　 Next </p> 
 
<p>　　 ConnTotal = ConnTotal + 1 </p> 
 
<p>　　 End If </p> 
 
<p>　　 Next </p> 
 
<p>　　 NWCCCloseConn (ServerHandle) </p> 
 
<p>　　End Sub </p> 
 
<p>　　Sub ViewRoomA(ConnNumOfRoomA As Integer) </p> 
 
<p>　　'  
该子程序的功能是：将学生机房的工作站名按顺序加入表格中，若该工作站有用户在  
</p> 
 
<p>　　'  
使用且已登录在服务器上，则在表中标明该工作站用户的帐号、登录时间、姓名。  
</p> 
 
<p>　　Dim db As Database </p> 
 
<p>　　Dim dt As Recordset </p> 
 
<p>　　Dim dtuser As Recordset </p> 
 
<p>　　Dim i As Integer </p> 
 
<p>　　Dim term As String </p> 
 
<p>　　Dim temp As String </p> 
 
<p>　　With roomafrm.rooma </p> 
 
<p>　　 .Cols = 6 </p> 
 
<p>　　 .Rows = 1 </p> 
 
<p>　　 .ColWidth(0) = 600 </p> 
 
<p>　　 .ColWidth(1) = 600 </p> 
 
<p>　　 .ColWidth(2) = 1000 </p> 
 
<p>　　 .ColWidth(3) = 1200 </p> 
 
<p>　　 .ColWidth(4) = 1200 </p> 
 
<p>　　 .ColWidth(5) = 1200 </p> 
 
<p>　　 .Col = 0 </p> 
 
<p>　　 .Text = &quot;已占用 &quot; </p> 
 
<p>　　 .Col = 1 </p> 
 
<p>　　 .Text = &quot;连接号&quot; </p> 
 
<p>　　 .Col = 2 </p> 
 
<p>　　 .Text = &quot;设备名&quot; </p> 
 
<p>　　 .Col = 3 </p> 
 
<p>　　 .Text = &quot;帐户名&quot; </p> 
 
<p>　　 .Col = 4 </p> 
 
<p>　　 .Text = &quot;登录时间 &quot; </p> 
 
<p>　　 .Col = 5 </p> 
 
<p>　　 .Text = &quot;用户名&quot; </p> 
 
<p>　　End With </p> 
 
<p>　　Set db = OpenDatabase(&quot;c:\workshop\netsoft\net.mdb&quot;) </p> 
 
<p>　　Set dt = db.OpenRecordset(&quot;RoomA&quot;, dbOpenDynaset) </p> 
 
<p>　　Set dtuser = db.OpenRecordset(&quot;user&quot;, dbOpenDynaset) </p> 
 
<p>　　dt.MoveFirst </p>

<p>　　temp = &quot;&quot; </p> 
 
<p>　　ConnNumOfRoomA = 0 </p> 
 
<p>　　While Not dt.EOF </p> 
 
<p>　　 temp = &quot; &quot; &amp; vbTab &amp; &quot;&quot; &amp; vbTab &amp; dt!cname  
&amp; vbTab </p> 
 
<p>　　 For i = 0 To ConnTotal </p> 
 
<p>　　 If Trim(Address(i)) = Trim(dt!naddr) Then </p> 
 
<p>　　 ConnNumOfRoomA = ConnNumOfRoomA + 1 </p> 
 
<p>　　 temp = &quot;*&quot; &amp; vbTab &amp; connNum(i) &amp; vbTab &amp; dt!cname _ </p> 
 
<p>　　 &amp; vbTab &amp; Trim((AccountName(i))) &amp; vbTab &amp; Format(loginTime(i),  
_ </p> 
 
<p>　　 &quot;00:00:00&quot;) &amp; vbTab </p> 
 
<p>　　 term = &quot;accountname='&quot; &amp; Trim(AccountName(i)) &amp; &quot;'&quot; </p> 
 
<p>　　 dtuser.FindFirst term </p> 
 
<p>　　 If Not dtuser.NoMatch Then </p> 
 
<p>　　 temp = temp &amp; dtuser!userName </p> 
 
<p>　　 Else </p> 
 
<p>　　 temp = temp &amp; &quot;NOT FOUND&quot; </p> 
 
<p>　　 End If </p> 
 
<p>　　 Exit For </p> 
 
<p>　　 End If </p> 
 
<p>　　 Next </p> 
 
<p>　　 If Trim(dt!flag) = &quot;student&quot; Then </p> 
 
<p>　　 With roomafrm.rooma </p> 
 
<p>　　 .AddItem temp </p> 
 
<p>　　 End With </p> 
 
<p>　　 End If </p> 
 
<p>　　 dt.MoveNext </p> 
 
<p>　　Wend </p>

<p>　　dt.Close </p>

<p>　　dtuser.Close </p>

<p>　　db.Close </p>

<p>　　End Sub </p> 
 
<p>　　调用这个程序实现的功能<a
href="http://www.zdnet.com.cn/pcc/99_01/images/12901.gif">如图所示</a>。 </p>

<p>　　程序实现的功能 </p>

<p>　　这个例子只是对Netware SDK工具的简单应用，该工具包含了丰富的函数，通过调用这些函数能在Netware下编写出许多有用的应用程序。pcc  
</p> 
 
<p>　　（作者地址：重庆邮电学院管理系 400065 </font></p> 
      　</td> 
  </tr> 
</table> 
</center></div> 
 
<p>　</p>

</body>
</html>
