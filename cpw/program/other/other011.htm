<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title>您现在的位置是</title>
</head>

<body>

<div align="center"><center>

<table border="1" cellspacing="0" cellpadding="2" width="100%" style="font-size: 9pt"
bordercolor="#000000" bordercolordark="#FFFFFF">
  <tr bgcolor="#CCFFCC">
    <td><span style="font-size: 9pt">您现在的位置是： <b><a href="../progidx.htm">编程技巧  
      </a> --&gt; <a href="oth_idx.htm">其它</a></b></span></td>    
  </tr>    
</table>    
</center></div><div align="center"><center>    
    
<table border="1" width="100%" style="font-size: 9pt" bgcolor="#FFFFFF"    
bordercolor="#000000" cellpadding="2" cellspacing="0" bordercolordark="#FFFFFF">    
  <tr>    
    <td width="85%" align="left" valign="top"><table border="1" width="32%" style="font-size: 9pt" height="30"    
    cellspacing="0" cellpadding="2" bgcolor="#FFFFFF" bordercolor="#000000"    
    bordercolordark="#FFFFFF">    
      <tr>    
        <td width="100%" bgcolor="#4264B5"><p align="center"><span style="font-size: 9pt"><font    
        color="#FFFFFF">资料整理&middot;<a href="http://chinaprog.yeah.net" target="_blank"    
        style="color: rgb(255,255,255)">中国程序员网站</a></font></span></td>    
      </tr>    
    </table>    
      <p>　</p> 
      <p align="center"> 修复被CIH破坏的硬盘一例（FAT32）&nbsp;<br> 
      作者： RobertYore</p>  
      <p><br>  
      Robert Yore: 修复被CIH强奸过的硬盘之《步骤说明》<br>  
      工具软件：Norton Utility 8.0 中的 NDD.*/DISKEDIT.*/NLIB200.RTL     ；老工具了<br>  
      系统软件：Windows 9X 启动软盘                     ；自制<br>  
      杀毒软件：KV300 Z版 (Cracked)                      ；staryang.yeah.net上Down的。<br>  
      测试环境：Windows 95 (FAT32)/HP OmniBook 3000(HDD:4GB)/主板BIOS良好<br>  
      <br>  
      1)    用无毒系统Windows 9X软盘启动计算机，进入CMOS SETUP，将系统日期修改为26日以前。<br>  
      2)    用软盘重新引导计算机，运行FDISK /MBR，清除主引导记录MBR代码区。<br>  
      3)    运行DEBUG，输入以下程序：<br>  
        -a<br>  
        XXXX:0100 mov ax,201<br>  
        XXXX:0103 mov bx,1000<br>  
        XXXX:0106 mov cx,1<br>  
        XXXX:0109 mov dx,80<br>  
        XXXX:010C int13<br>  
        XXXX:010E int3<br>  
        XXXX:010F [回车]<br>  
        -g<br>  
        ......(显示寄存器结果，略去)<br>  
        -f11BE 11FD 00<br>  
        -f11FE 11FF 55 AA<br>  
        -a100<br>  
        XXXX:0100 mov ax,301<br>  
        XXXX:0103 [回车]<br>  
        -g=100<br>  
        ......<br>  
        -q<br>  
    以上程序清空分区表。或者，直接运行DISKEDIT，选择物理驱动器HARD DISK 1，按Alt-P选择物理扇区，Side 0，Cylinder 0，Sector 1，用00清空偏移01BE至01FD，并在扇区最后输入55，AA。在启动DISKEDIT后，系统自动设为READ ONLY，从菜单中选TOOLS-]CONFIGURATION，<br>  
    清除READ ONLY标记并回车，就可以对硬盘进行写操作了。在写操作之后，按Ctrl-W存盘。<br>  
      4)    清空分区表后，用NDD重建原分区。如果硬盘上还有除C以外的逻辑分区，可以一齐找回。<br>  
      5)    为重建逻辑驱动器C，下面将计算FAT区：<br>  
        a)    Windows 9X操作系统的逻辑驱动器C的BOOT区在Cylinder 0，Side 1，Sector 1。<br>  
        b)    用DISKEDIT的FIND功能寻找ASC II字符串：COMMAND COM<br>  
            （COMMAND与COM中间有一个空格，ASC II值为20，找寻FDT表中COMMAND.COM的原因是，根目录中一般都有此文件，如果你的计算机里该文件不在根目录，就将上述字符串改为根目录中的其他文件名，如IO.SYS或MSDOS.SYS。但要注意文件名和后缀名之间要有空格，总长度为11字节）<br>  
        c)    找到后，用PgUp向前翻页，直到上一扇区尾部出现连续的00（一般说，没见过硬盘的最后几十K还有存放数据的情况，否则，Windows 9X的<br>  
            虚拟内存恐怕就没法建立了，:-)）<br>  
        d)    记录该扇区的Cylinder，Side，Sector值。――ROOT<br>  
        e)    寻找FAT2的开始扇区，其特点是：<br>  
            （要选中“Search at specified sector offset:[0...]”）<br>  
                扇区偏移0000H处为F8 FF FF    ；FAT16<br>  
                扇区偏移0000H处为F8 FF FF FF    ；FAT32<br>  
            找到后，确认上一扇区尾部出现连续的00，则该扇区为FAT2头部。<br>  
            （FAT1应与FAT2内容相同，但其头部数个扇区已被CIH破坏）<br>  
        f)    记录该扇区的Cylinder，Side，Sector值。――FAT2<br>  
        g)    计算FAT2的扇区数，用以下公式，其中，尾标0为FAT2地址，尾标1为ROOT地址：<br>  
            扇区数=(Cylinder1-Cylinder0)*Sectors/Cylinder+(Side1-Side0)*Sides*Sectors/Cylinder+Sector1-Sector0<br>  
            说明：Sectors/Cylinder为每道扇区数，Sides为硬盘的总磁头数。一个简单的查看方法是：在DISKEDIT中按下[End]键，屏幕右下角的Sector值即为每道扇区数，而Side值+1即为总磁头数。FAT1扇区数与FAT2相同。<br>  
        h)    计算出FAT1头部地址，并记录。――FAT1<br>  
        i)    在DISKEDIT中按Alt-P重选Physical Sector，起始地址为步骤e)记录的地址。扇区数为步骤g)计算出的扇区数。按Alt-W将选中的扇区（即FAT2）存至FAT1开始的地址（步骤h)计算出的FAT1头部）。<br>  
        j)    至此，FAT2-]FAT1的恢复工作宣告结束。<br>  
      6)    下面恢复主引导记录中的标志：<br>  
    用DISKEDIT选择Cylinder 0，Side 0，Sector 1，将此扇区尾部偏移为01C2H地址的标志修复。如果为FAT16系统，应为06H；如果为FAT32系统，应为0CH。均表示PRI-DOS分区。<br>  
      7)    恢复BOOT扇区，位置在Cylinder 0，Side 1，Sector 1，以下用0-1-1表示，以此类推。<br>  
        a)    在步骤5)中，已计算出了FAT1的起始位置。在FAT16系统中，FAT1一般自0-1-2开始；在FAT32系统中，FAT1一般自0-1-33开始。如果你的系统与此不同，以实际计算出的数值为准。<br>  
        b)    将FAT1的起始扇区号减1，就是系统的隐含扇区数，一般FAT16为1，FAT32为32。<br>  
        c)    如为FAT16系统，跳过本步骤，至d)。选择一台无毒的FAT32系统作参考，将0-1-1至FAT1前面的隐含扇区保存到软盘文件（同5)i)的操作方法，只是地址、长度不同），假设文件名为abc.bin，然后，用DEBUG写入带毒硬盘。程序如下：<br>  
                -n a:\abc.bin<br>  
                -l1000<br>  
                -rbx<br>  
                BX:????<br>  
                :0<br>  
                -rcx<br>  
                CX:????<br>  
                :4000         ；FAT32 系统的隐含扇区数*512，16进制<br>  
                -w1000 2 0 1<br>  
                -q<br>  
        d)    用DISKEDIT按Alt-P选择0-1-1（BOOT区），按F7以BOOT区方式显示。<br>  
            i) 修改 Sectors per cluster，公式为：<br>  
            C盘容量（估计值，GB）*1024*1024/(FAT2扇区数*512/4)*2；FAT32<br>  
            C盘容量（估计值，GB）*1024*1024/(FAT2扇区数*512/2)*2；FAT16<br>  
            将计算结果取整，C盘容量不必精确，毛估估就行。一般为8,16,...128。<br>  
            ii) 修改 Reserved sectors at beginning，改为7)b)的计算结果。<br>  
            iii)修改 Sectors per FAT：<br>  
                如为FAT16系统，直接改为5)g)的计算结果。如为FAT32系统，按F2切换到Hex显示方式，将5)g)结果写入偏移24H开始的几个字节，注意，高位在后，低位在前。16进制。<br>  
            iv) 修改 Sectors per track，改为5)g)中的“每道扇区数”<br>  
            v) 修改 Sides，改为5)g)中的“总磁头数”<br>  
            vi) 按Ctrl-W存盘。<br>  
      8)    至此，所有修改完成。<br>  
      9)    用软盘重新引导开机。切换到C盘，DIR查看目录，如无文件信息，可能是FAT1/FAT2的扇区数计算有误，加1后修改存盘并重启动；如出现不可读字符，减1后修改存盘并重启动。<br>  
      <br>  
      经过此方法修改后，一般可将损坏的数据全部修复，除非你的硬盘分区过小，如FAT16：小于20MB。而CIH将0-0-1和0-1-1两道中的前100个左右的扇区用随机数据进行了覆盖，除了破坏了FAT1，连FAT2也无法幸免……不过，区区20MB的C盘，你恢复它干吗？:-)我的硬盘可是有4个GB呢，而且只剩不到100MB的空间了。所以才修了一夜……<br>  
      <br>  
      另外，如果那位朋友有更好、更简便的方法，请务必告知本人，大家共勉嘛……哈哈！  
      <p>------------------------------------------------------------------------------------------------------------------------<br> 
      <p>由于一时疏忽，上面的文章里有一处错误：<br>
      在5)g)中计算FAT2长度时，将(Side1-Side0)与(Cylinder1-Cylinder0)颠倒了，这样计算出来的FAT2长度比实际的小很多。尽管不会破坏FAT2，但确实也无法修复FAT1。见谅！ 
    </td>    
  </tr>    
</table>    
</center></div>    
<p><br> 
<br> 
<br> 
<br> 
</p> 
 
</body> 
 
</html> 
