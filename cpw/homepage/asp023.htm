<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title>您现在的位置是</title>
</head>

<body>

<div align="center"><center>

<table border="1" cellspacing="0" cellpadding="2" width="100%" style="font-size: 9pt"
bordercolor="#000000" bordercolordark="#FFFFFF">
  <tr bgcolor="#CCFFCC">
    <td><span style="font-size: 9pt">您现在的位置是： <b><a href="home_idx1.htm">主页制作</a></b></span></td>  
  </tr>  
</table>  
</center></div><div align="center"><center>  
  
<table border="1" width="100%" style="font-size: 9pt" bgcolor="#FFFFFF"  
bordercolor="#000000" cellpadding="2" cellspacing="0" bordercolordark="#FFFFFF">  
  <tr>  
    <td width="85%" align="left" valign="top"><table border="1" width="32%" style="font-size: 9pt" height="30"  
    cellspacing="0" cellpadding="2" bgcolor="#FFFFFF" bordercolor="#000000"  
    bordercolordark="#FFFFFF">  
      <tr>  
        <td width="100%" bgcolor="#4264B5"><p align="center"><span style="font-size: 9pt"><font  
        color="#FFFFFF">资料整理&middot;<a href="http://chinaprog.yeah.net" target="_blank"  
        style="color: rgb(255,255,255)">中国程序员网站</a></font></span></td>  
      </tr>  
    </table>  
      <p align="center"><font class="a"><b>五、会话终止</b>
      <p align="right">作 者 : <a href="mailto:microsoftwindows@126.com">仙人掌工作室</a>
      <p>　　 当ASP会话结束时会运行global.asa中的Session_OnEnd方法，可以在这里删除保存在Application(&quot;Users&quot;)数组中由于超时而被终止会话的用户。记录用户是由于什么原因（超时还是显式退出）终止会话往往很有用处，下面的代码通过更新Users表的TimedOut字段实现该功能：<br>
      sub Session_OnEnd<br>
      dim AppUsers<br>
      dim aUser<br>
      dim i<br>
      dim j<br>
      dim conn<br>
      dim supportsCookies<br>
      dim foundUser<br>
      on error resume next<br>
      supportsCookies=Session(&quot;SupportsCookies&quot;)<br>
      Application.Lock<br>
      AppUsers = Application(&quot;Users&quot;)<br>
      foundUser = false<br>
      for i = 0 to ubound(AppUsers)<br>
      set aUser = AppUsers(i)<br>
      if supportsCookies then<br>
      if aUser(&quot;SessionID&quot;) = Session.SessionID then<br>
      foundUser = true<br>
      end if<br>
      elseif dateAdd(&quot;n&quot;, Session.timeout, 
      aUser(&quot;LastActivity&quot;)) &lt; now() then<br>
      foundUser = true<br>
      end if<br>
      if foundUser then<br>
      set conn = server.createObject(&quot;ADODB.Connection&quot;)<br>
      conn.ConnectionString=Session(&quot;ConnectionString&quot;)<br>
      conn.ConnectionTimeout=Session(&quot;ConnectionTimeout&quot;)<br>
      conn.mode=Session(&quot;Mode&quot;)<br>
      conn.open<br>
      conn.execute &quot;UPDATE Users SET TimedOut=1 WHERE Users.Signon='&quot; 
      &amp; aUser(&quot;Signon&quot;) &amp; &quot;'&quot;<br>
      conn.close<br>
      set conn=nothing<br>
      set aUser=nothing<br>
      set AppUsers(i) = nothing<br>
      for j = i to ubound(AppUsers) - 1<br>
      set AppUsers(j) = AppUsers(j + 1)<br>
      next<br>
      if ubound(AppUsers) &gt; 0 then<br>
      redim preserve AppUsers(ubound(AppUsers) - 1)<br>
      else<br>
      AppUsers = Array()<br>
      end if<br>
      exit for<br>
      end if<br>
      next<br>
      Application(&quot;Users&quot;) = AppUsers<br>
      Application.UnLock<br>
      end sub<br>
      <p>　　 请从<a href="http://www.chinabyte.com/builder/ASPSecurity.zip">这里下载本文完整的代码</a>（<a href="http://www.chinabyte.com/builder/ASPSecurity.zip">ASPSecurity.zip</a>，18K）。</font>
      <p align="right">　
      <p><font class="a">　 <a href="asp019.htm">第1页</a>　 <a href="asp020.htm">第2页</a>　 
      <a href="asp021.htm">第3页</a>　 <a href="asp022.htm">第4页</a>　 
      第5页　</font>  
      <p>　  
    </td>  
  </tr>  
</table>  
</center></div>  

</body>

</html>
